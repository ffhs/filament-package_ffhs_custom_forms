<?phpnamespace Ffhs\FilamentPackageFfhsCustomForms\Filament\Component\FormEditor\TypeActions;use Ffhs\FfhsUtils\Filament\Components\ElevatedActions;use Ffhs\FilamentPackageFfhsCustomForms\CustomFieldType\LayoutType\Types\GroupType;use Ffhs\FilamentPackageFfhsCustomForms\CustomForm\FormConfiguration\CustomFormConfiguration;use Ffhs\FilamentPackageFfhsCustomForms\Models\CustomField;use Ffhs\FilamentPackageFfhsCustomForms\Models\CustomForm;use Ffhs\FilamentPackageFfhsCustomForms\Traits\CanCloneCustomForm;use Ffhs\FilamentPackageFfhsCustomForms\Traits\CanLoadCustomFormEditorData;use Filament\Forms\Components\Concerns\CanGenerateUuids;use Filament\Schemas\Components\Component;use Filament\Schemas\Components\Utilities\Get;use Filament\Schemas\Components\Utilities\Set;use Filament\Support\Colors\Color;class DefaultTemplateDissolveAction extends FieldTypeAction{    use CanLoadCustomFormEditorData;    use CanCloneCustomForm;    use CanGenerateUuids;    protected function setUp(): void    {        parent::setUp();        $this            ->iconButton()            ->closeModalByClickingAway(false)            ->icon('carbon-sync-settings')            ->color(Color::hex('#de9310'))            ->label(CustomField::__('actions.dissolve.label'))            ->tooltip(CustomField::__('actions.dissolve.tooltip'))            ->action($this->dissolve(...))            ->requiresConfirmation()            ->modalHeading(function (CustomFormConfiguration $formConfiguration, array $state) {                $template = $formConfiguration                    ->getAvailableTemplates()                    ->get($state['template_id']);                /**** @var CustomForm $template */                $name = $template->short_title;                return trans(CustomField::__('actions.dissolve.heading'), ['name' => $name]);            });    }    protected function dissolve(        CustomFormConfiguration $formConfiguration,        string $value,        array $state,        Get $get,        Set $set,        Component $component,    ): void {        /** @var ?CustomForm $template */        $templateId = $state['template_id'];        $template = $formConfiguration            ->getAvailableTemplates()            ->get($templateId);        if (is_null($template)) {            return;        }        $this->dissolveFields($formConfiguration, $get, $set, $value, $template);        $this->dissolveRules($set, $get, $template, $component);    }    protected function dissolveFields(        CustomFormConfiguration $formConfiguration,        Get $get,        Set $set,        string $value,        CustomForm $template,    ): void {        //Get Template Fields        $templateFormData = $this->loadCustomFormEditorData($template);        $templateFields = $templateFormData['custom_fields'];        //CustomFieldAnswerer CustomField id changing is handelt in TemplateFieldType.class on afterEditFieldDelete()        $clearedTemplateFields = array_map(            fn($field) => $this->cloneField($field, $formConfiguration),            $templateFields        );        //Put template fields in a group        $clearedTemplateFields = $this->putFieldsInGroup($formConfiguration, $clearedTemplateFields);        $customFields = $get('../');        $customFields = $this->replaceArrayKey($customFields, $value, $clearedTemplateFields['identifier'],            $clearedTemplateFields);        //Set the fields back in the repeater        $set('../../custom_fields', $customFields);    }    protected function replaceArrayKey(array $array, $oldKey, $newKey, $newValue = null): array    {        // Wenn der neue Wert nicht angegeben ist, verwende den alten Wert        if ($newValue === null) {            $newValue = $array[$oldKey] ?? null;        }        $keys = array_keys($array);        $values = array_values($array);        $position = array_search($oldKey, $keys);        if ($position !== false) {            $keys[$position] = $newKey;            $values[$position] = $newValue;            return array_combine($keys, $values);        }        return $array;    }    protected function putFieldsInGroup(CustomFormConfiguration $formConfiguration, array $clearedTemplateFields): array    {        $options = ['column_span' => 10, 'columns' => $formConfiguration->getColumns()];        $options += GroupType::make()->getDefaultTypeOptionValues();        return [            'is_active' => true,            'identifier' => $this->generateUuid(),            'type' => GroupType::identifier(),            'options' => $options,            'custom_fields' => $clearedTemplateFields,        ];    }    protected function dissolveRules(Set $set, Get $get, CustomForm $template, ElevatedActions $component): void    {        $rulePath = $this->getStringUntilFirstCustomFields($component->getStatePath()) . '.rules';        $rules = array_map($this->cloneRule(...), $this->loadEditorRules($template));        $oldState = $get($rulePath, true) ?? [];        $rules = array_merge($oldState, $rules);        $set($rulePath, $rules, true);    }    private function getStringUntilFirstCustomFields(string $input): string    {        $position = strpos($input, 'custom_fields');        if ($position !== false) {            $result = substr($input, 0, $position);            // Entferne den abschlie√üenden Punkt, falls vorhanden            return rtrim($result, '.');        }        return $input;    }}